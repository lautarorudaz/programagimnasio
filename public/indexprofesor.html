<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio</title>
    <link rel="stylesheet" href="/public/css/indexprofesor.css">
</head>
<body>

<nav class="navbar">
    <div class="logo-container">
        <a href="indexprofesor.html" class="logo-text">Anima App</a>
    </div>

    <div class="menu-toggle" id="mobile-menu">
        <span class="bar"></span>
        <span class="bar"></span>
        <span class="bar"></span>
    </div>

    <ul class="nav-links">
        <li><a href="indexprofesor.html" class="active">Inicio</a></li>
        <li><a href="/public/alumno.html">Alumnos</a></li>
        <li><a href="cuotas.html">Cuotas</a></li>
        <li><a href="/public/rutina.html">Rutinas</a></li>
        <li><button class="btn-cerrar-sesion" onclick="cerrarSesion()">Cerrar Sesi√≥n</button></li>
    </ul>
</nav>



<div class="app-container">


    <main class="main-content">
        <header class="welcome-header">
            <h1>Panel de Control</h1>
            <p>Bienvenido, <span id="nombreProfe" class="text-blue">Profesor</span></p>
        </header>

        <section class="stats-container">
            <div class="stat-card">
                <span class="stat-title">Socios Activos</span>
                <span class="stat-number" id="totalSocios">0</span>
            </div>
            <div class="stat-card">
                <span class="stat-title">Rutinas Activas</span>
                <span class="stat-number" id="totalRutinas">0</span>
            </div>
            <div class="stat-card">
                <span class="stat-title">Cuotas OK</span>
                <span class="stat-number" id="totalCuotasOk">0</span>
            </div>
            <div class="stat-card urgent">
                <span class="stat-title">Vencidas</span>
                <span class="stat-number" id="totalVencidas">0</span>
            </div>
        </section>

        <div class="header-profes">
    <button class="btn-nuevo" onclick="abrirModalProfe()">+ Agregar Nuevo Profesor</button>
</div>

<div id="modalProfe" class="modal">
    <div class="modal-content">
        <span class="close" onclick="cerrarModalProfe()">&times;</span>
        <h2>Registrar Nuevo Profesor</h2>
        <form id="formNuevoProfe">
            <input type="text" id="p_nombre" placeholder="Nombre" required>
            <input type="text" id="p_apellido" placeholder="Apellido" required>
            <input type="email" id="p_email" placeholder="Correo Electr√≥nico" required>
            <input type="password" id="p_pass" placeholder="Contrase√±a de Acceso" required>
            <input type="number" id="p_edad" placeholder="Edad" required>
            <button type="submit" class="btn-guardar-profe">Habilitar Profesor</button>
        </form>
    </div>
</div>

<table>
    <thead>
        <tr>
            <th>Nombre y Apellido</th>
            <th>Correo</th>
            <th>Edad</th>
            <th>Alumnos a Cargo</th>
        </tr>
    </thead>
    <tbody id="listaProfesores"></tbody>
</table>
    </main>
</div>
<script>


const mobileMenu = document.getElementById('mobile-menu');
const navLinks = document.querySelector('.nav-links');

mobileMenu.addEventListener('click', () => {
    navLinks.classList.toggle('active');
});


function cerrarSesion() {
    // Borramos los datos del profesor del almacenamiento local
    localStorage.removeItem('usuarioLogueado');
    // Redirigimos al index (o login)
    window.location.href = 'sesion.html'; 
}



async function cargarProfesores() {
    try {
        const res = await fetch('http://localhost:3000/api/profesores-lista');
        const profesores = await res.json();
        const tabla = document.getElementById('listaProfesores');
        tabla.innerHTML = '';

        profesores.forEach(profe => {
            const tr = document.createElement('tr');
           tr.innerHTML = `
        <td data-label="Nombre">${profe.nombre} ${profe.apellido || ''}</td>
        <td data-label="Correo">${profe.email}</td>
        <td data-label="Edad">${profe.edad > 0 ? profe.edad + ' a√±os' : 'N/A'}</td> 
        <td data-label="Alumnos"><strong>${profe.total_alumnos}</strong> alumnos</td>
        <td>
            <button class="btn-eliminar" onclick="eliminarProfesor(${profe.id})">üóëÔ∏è Borrar</button>
        </td>
    `;
            tabla.appendChild(tr);
        });
    } catch (error) {
        console.error("Error cargando profes:", error);
    }
}

document.addEventListener('DOMContentLoaded', cargarProfesores);







function abrirModalProfe() {
    document.getElementById('modalProfe').style.display = 'block';
}

function cerrarModalProfe() {
    document.getElementById('modalProfe').style.display = 'none';
}

// Escuchar el env√≠o del formulario
document.getElementById('formNuevoProfe').onsubmit = async (e) => {
    e.preventDefault();

    const datos = {
        nombre: document.getElementById('p_nombre').value,
        apellido: document.getElementById('p_apellido').value,
        email: document.getElementById('p_email').value,
        password: document.getElementById('p_pass').value,
        edad: parseInt(document.getElementById('p_edad').value)
    };

    try {
        const res = await fetch('http://localhost:3000/api/registrar-profesor', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos)
        });

        if (res.ok) {
            alert("Profesor registrado con √©xito");
            cerrarModalProfe();
            cargarProfesores(); // Recargamos la lista para ver al nuevo colega
        } else {
            alert("Error al registrar");
        }
    } catch (error) {
        console.error("Error:", error);
    }
};




async function eliminarProfesor(id) {
    if (confirm("¬øEst√°s seguro de que quer√©s eliminar a este profesor? Esta acci√≥n no se puede deshacer.")) {
        try {
            const res = await fetch(`http://localhost:3000/api/eliminar-profesor/${id}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                alert("Profesor eliminado");
                cargarProfesores(); // Recargamos la lista autom√°ticamente
            } else {
                alert("Error al intentar eliminar");
            }
        } catch (error) {
            console.error("Error:", error);
        }
    }
}



document.addEventListener('DOMContentLoaded', () => {
    const profesorId = localStorage.getItem('usuarioId'); 
    const servidor = "http://localhost:3000"; // Definimos la base aqu√≠

    if (profesorId && profesorId !== 'undefined') {
        // Usamos la URL absoluta para evitar que el navegador use el puerto 5500 por error
        fetch(`${servidor}/api/estadisticas/${profesorId}`)
            .then(res => {
                if (!res.ok) throw new Error("Error en servidor");
                return res.json();
            })
            .then(data => {
                console.log("¬°√âxito! Datos recibidos:", data);
                
                // Mapeamos a tus IDs de HTML
                const sociosElem = document.getElementById('totalSocios');
                const rutinasElem = document.getElementById('totalRutinas');

                if (sociosElem) sociosElem.innerText = data.total || 0;
                if (rutinasElem) rutinasElem.innerText = data.rutinas || 0;
            })
            .catch(err => {
                console.error("Error en el fetch al 3000:", err);
            });
    } else {
        console.error("No hay profesorId v√°lido en localStorage");
    }

    // Eliminamos cualquier rastro de cargarStaff() que rompa el c√≥digo
    if (typeof cargarProfesores === "function") {
        cargarProfesores();
    }
});




document.addEventListener('DOMContentLoaded', async () => {
    // 1. Obtener datos del profesor desde el localStorage
    const usuarioLogueado = JSON.parse(localStorage.getItem('usuario'));

    if (!usuarioLogueado || usuarioLogueado.rol !== 'profesor') {
        window.location.href = 'sesion.html';
        return;
    }

    // 2. Mostrar el nombre en el saludo
    document.getElementById('nombreProfe').textContent = usuarioLogueado.nombre;

    // 3. Cargar estad√≠sticas reales desde el servidor
// 3. Cargar estad√≠sticas reales desde el servidor
try {
        const respuesta = await fetch(`http://localhost:3000/api/estadisticas/${usuarioLogueado.id}`);
        const stats = await respuesta.json();

        // Esta l√≠nea es la que manda el mensaje a tu consola
        console.log("¬°Ahora s√≠! Datos actualizados:", stats); 

        // 1. Buscamos los elementos por su ID
        const sociosElem = document.getElementById('totalSocios');
        const rutinasElem = document.getElementById('totalRutinas');

        // 2. Les asignamos el valor usando los nombres EXACTOS de tu consola
        if (sociosElem) {
            sociosElem.textContent = stats.totalSocios; // Antes quiz√°s dec√≠a totalAlumnos
        }
        
        if (rutinasElem) {
            rutinasElem.textContent = stats.totalRutinas; // Antes quiz√°s dec√≠a rutinas o activos
        }

    } catch (error) {
        console.error("Error al mostrar datos:", error);
    }
}); // <--- ESTA LLAVE CIERRA EL DOMContentLoaded. ¬°ASEG√öRATE DE QUE EST√â!



async function cargarEstadisticas() {
    const miSesion = JSON.parse(localStorage.getItem('usuario'));
    if (!miSesion) return;

    try {
        // Asegurate de que la URL sea la misma que usamos antes (api/estadisticas)
        const respuesta = await fetch(`http://localhost:3000/api/estadisticas/${miSesion.id}`);
        const data = await respuesta.json();

        // CAMBIO CLAVE: Usamos los nombres que ves en tu consola (image_999c27.png)
        const sociosElem = document.getElementById('totalSocios');
        const rutinasElem = document.getElementById('totalRutinas');

        if (sociosElem) sociosElem.textContent = data.totalSocios ?? 0;
        if (rutinasElem) rutinasElem.textContent = data.totalRutinas ?? 0;
        
        // Estos de abajo pod√©s dejarlos as√≠ o ajustarlos cuando el server los env√≠e
        document.getElementById('totalCuotasOk').textContent = data.totalCuotasOk ?? 0;
        document.getElementById('totalVencidas').textContent = data.totalVencidas ?? 0;

    } catch (error) {
        console.error("Error:", error);
    }
}

document.addEventListener('DOMContentLoaded', cargarEstadisticas);


// Se ejecuta apenas carga la p√°gina
document.addEventListener('DOMContentLoaded', cargarEstadisticas);




</script>
</body>
</html>
