<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Alumnos - Anima App</title>
    <link rel="stylesheet" href="/public/css/alumno.css">
</head>
<body>

  <nav class="navbar">
    <div class="nav-container">
        <a href="#" class="logo">Anima App</a>
        
        <button class="menu-toggle" id="mobile-menu">
            <span class="bar"></span>
            <span class="bar"></span>
            <span class="bar"></span>
        </button>

        <ul class="nav-links" id="nav-links">
            <li><a href="indexprofesor.html">Inicio</a></li>
            <li><a href="alumno.html" class="active">Alumnos</a></li>
            <li><a href="cuotas.html">Cuotas</a></li>
            <li><a href="/public/rutina.html">Rutinas</a></li>
            <li><button onclick="cerrarSesion()" class="btn-logout">Cerrar Sesi√≥n</button></li>
        </ul>
    </div>
</nav>

    <main class="main-content">
        <div class="header-section">
            <h1>Gesti√≥n de Alumnos</h1>
            <button class="btn-agregar" onclick="abrirModal()">+ Agregar Nuevo Alumno</button>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Nombre y Apellido</th>
                        <th>Email</th>
                        <th>Edad</th>
                        <th>Fecha de alta</th>
                        <th>Estado</th>
                        <th >Acciones</th>
                    </tr>
                </thead>
                <tbody id="tablaAlumnosReal">
                    </tbody>
            </table>
        </div>
    </main>

    <div id="modalAlumno" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="cerrarModal()">&times;</span>
            <h2>Registrar Alumno</h2>
            <form id="formAlumno">
                <div class="input-group">
                    <label>Nombre</label>
                    <input type="text" id="nombre" placeholder="Ej: Juan" required>
                </div>
                <div class="input-group">
                    <label>Apellido</label>
                    <input type="text" id="apellido" placeholder="Ej: P√©rez" required>
                </div>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="ejemplo@correo.com" required>
                </div>
                 <div class="input-group">
                    <label>Contrase√±a</label>
                    <input type="password" id="passAlumno" placeholder="Contrase√±a temporal" required>
                </div>
                <div class="input-group">
                    <label>Edad</label>
                    <input type="number" id="edad" placeholder="25" required>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn-confirm">Guardar Alumno</button>
                    <button type="button" class="btn-cancel" onclick="cerrarModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>


// 1. VARIABLES GLOBALES
    const formulario = document.getElementById('formAlumno');
    const tabla = document.getElementById('tablaAlumnosReal');
    const modal = document.getElementById('modalAlumno');
    // Obtenemos tu sesi√≥n (Aseg√∫rate que en el login guardes como 'usuario')
    const miSesion = JSON.parse(localStorage.getItem('usuario'));

    // 2. CONTROL DE ACCESO (Seguridad)
    if (!miSesion || miSesion.rol !== 'profesor') {
        alert("Acceso denegado");
        window.location.href = 'sesion.html';
    }

    // 3. FUNCIONES DEL MODAL
    function abrirModal() {
        modal.style.display = 'block';
    }

    function cerrarModal() {
        modal.style.display = 'none';
        formulario.reset();
    }

    // 4. FUNCI√ìN PARA CARGAR LA TABLA (Traer datos de MySQL)
async function cargarAlumnos() {
    const tabla = document.getElementById('tablaAlumnosReal');
    const miSesion = JSON.parse(localStorage.getItem('usuario'));

    try {
        const respuesta = await fetch(`http://localhost:3000/api/alumnos/${miSesion.id}`);
        const alumnos = await respuesta.json();

        tabla.innerHTML = ""; 

        alumnos.forEach(alum => {
            const fecha = new Date(alum.fecha_alta).toLocaleDateString();
            const estaActivo = alum.estado === 1;
            
            const tr = document.createElement('tr');
            if (!estaActivo) tr.style.opacity = "0.5";

            // Aqu√≠ armamos la fila sin dejar palabras sueltas que den error
tr.innerHTML = `
    <td data-label="Nombre"><span>${alum.nombre} ${alum.apellido}</span></td>
    <td data-label="Email"><span>${alum.email}</span></td>
    <td data-label="Edad"><span>${alum.edad}</span></td>
    <td data-label="Fecha"><span>${fecha}</span></td>
    <td data-label="Estado"><span>${estaActivo ? 'Activo' : 'Pausado'}</span></td>
    <td data-label="Acciones" class="actions-cell">
        <button class="btn-action" onclick="editar(${alum.id})">‚úèÔ∏è</button>
        <button class="btn-action" id="btn-estado-${alum.id}">${estaActivo ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}</button>
        <button class="btn-action" onclick="eliminar(${alum.id})">üóëÔ∏è</button>
    </td>
`;
            
            tabla.appendChild(tr);

            // Vinculamos el evento de forma segura (as√≠ evitamos el "not defined")
            document.getElementById(`btn-estado-${alum.id}`).addEventListener('click', () => {
                cambiarEstado(alum.id, alum.estado);
            });
        });
    } catch (error) {
        console.error("Error cargando tabla:", error);
    }
}

    // 5. FUNCI√ìN PARA GUARDAR (Enviar a MySQL)
    formulario.addEventListener('submit', async (e) => {
        e.preventDefault();

        const nuevoAlumno = {
            nombre: document.getElementById('nombre').value,
            apellido: document.getElementById('apellido').value,
            email: document.getElementById('email').value,
            password: document.getElementById('passAlumno').value,
            edad: document.getElementById('edad').value,
            profesor_id: miSesion.id // Te vinculamos autom√°ticamente
        };

        try {
            const res = await fetch('http://localhost:3000/api/alumnos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(nuevoAlumno)
            });

            if (res.ok) {
                alert("‚úÖ Alumno guardado con √©xito");
                cerrarModal();
                cargarAlumnos(); // Refrescamos la tabla sin recargar la p√°gina
            } else {
                alert("‚ùå Error al guardar");
            }
        } catch (error) {
            alert("No hay conexi√≥n con el servidor (Node)");
        }
    });

    // 6. INICIO AUTOM√ÅTICO
    // Apenas carga la p√°gina, traemos los alumnos
    document.addEventListener('DOMContentLoaded', cargarAlumnos);


// ELIMINAR ALUMNO
async function eliminar(id) {
    if (confirm("¬øEst√°s seguro de que deseas dar de baja a este alumno?")) {
        try {
            const res = await fetch(`http://localhost:3000/api/alumnos/${id}`, {
                method: 'DELETE'
            });

            if (res.ok) {
                alert("Alumno eliminado correctamente");
                cargarAlumnos(); // Recargamos la tabla para que desaparezca
            } else {
                alert("Error al eliminar el alumno");
            }
        } catch (error) {
            console.error("Error de conexi√≥n:", error);
        }
    }
}

// EDITAR ALUMNO
function editar(id) {
    alert("Funci√≥n para editar el alumno ID: " + id + " pr√≥ximamente disponible.");
    // Aqu√≠ podr√≠as abrir un modal con los datos cargados para modificar
}




async function cambiarEstado(id, estadoActual) {
    const nuevoEstado = estadoActual === 1 ? 0 : 1;
    console.log(`Intentando cambiar alumno ${id} al estado: ${nuevoEstado}`);

    try {
        const res = await fetch(`http://localhost:3000/api/alumnos/estado/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nuevoEstado: nuevoEstado })
        });

        if (res.ok) {
            console.log("Servidor respondi√≥ OK");
            await cargarAlumnos(); // Esto vuelve a dibujar la tabla con los datos nuevos
        } else {
            const errorMsg = await res.text();
            alert("El servidor no pudo actualizar: " + errorMsg);
        }
    } catch (error) {
        console.error("Error de red:", error);
        alert("No se pudo conectar con el servidor.");
    }
}




// Cargar la tabla apenas se abre la p√°gina
document.addEventListener('DOMContentLoaded', cargarAlumnos);






// L√≥gica para abrir/cerrar men√∫ hamburguesa
const menuBtn = document.getElementById('mobile-menu');
const navLinks = document.getElementById('nav-links');

menuBtn.addEventListener('click', () => {
    navLinks.classList.toggle('active');
});

// MODIFICA tu funci√≥n cargarAlumnos para que incluya los data-label:
alumnos.forEach(alum => {
    const tr = document.createElement('tr');
    const estaActivo = parseInt(alum.estado) === 1;

    tr.innerHTML = `
        <td data-label="Alumno">${alum.nombre} ${alum.apellido}</td>
        <td data-label="Email">${alum.email}</td>
        <td data-label="Edad">${alum.edad}</td>
        <td data-label="Alta">${new Date(alum.fecha_alta).toLocaleDateString()}</td>
        <td data-label="Estado">
            <span class="badge ${estaActivo ? 'bg-success' : 'bg-danger'}">
                ${estaActivo ? 'Activo' : 'Pausado'}
            </span>
        </td>
        <td class="actions-cell">
            <button class="btn-action" onclick="editar(${alum.id})">‚úèÔ∏è</button>
            <button class="btn-action" onclick="cambiarEstado(${alum.id}, ${alum.estado})">
                ${estaActivo ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è'}
            </button>
            <button class="btn-action" onclick="eliminar(${alum.id})">üóëÔ∏è</button>
        </td>
    `;
    tabla.appendChild(tr);
});




// 3. FUNCI√ìN DE CIERRE DE SESI√ìN
function cerrarSesion() {
    localStorage.removeItem('usuarioLogueado');
    window.location.href = 'sesion.html';
}




    </script>
</body>
</html>


















